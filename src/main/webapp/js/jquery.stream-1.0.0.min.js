/*
 * jQuery Stream 1.0.0
 * Comet Streaming JavaScript Library 
 * http://code.google.com/p/jquery-stream/
 * 
 * Copyright 2011, Donghwan Kim 
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Compatible with jQuery 1.4+
 */
(function(c){function e(a,b){this.url=a;this.options=c.extend(!0,{},this.options,b);for(var f in{open:1,message:1,error:1,close:1})this.options[f]=c.makeArray(this.options[f]);e.instances[this.url]=this;var d=this;if(g)switch(this.options.throbber.type||this.options.throbber){case "lazy":c(window).load(function(){setTimeout(function(){d.open()},d.options.throbber.delay||50)});break;case "reconnect":d.open(),c(window).load(function(){function a(){d.options.close.push(function(){d.options.close.pop(); setTimeout(function(){d.readyState=0;d.open()},d.options.throbber.delay||50)});var b=d.options.reconnect;d.close();d.options.reconnect=b}d.readyState===0?d.options.open.push(function(){d.options.open.pop();setTimeout(function(){a()},10)}):a()})}else setTimeout(function(){d.open()},0)}function h(a,b){(function d(){setTimeout(function(){b.call(a)!==!1&&d()},0)})()}var g=c.browser.webkit&&!c.isReady;g&&c(window).load(function(){g=!1});c.extend(e.prototype,{options:{reconnect:!0,throbber:"lazy",dataType:"text", converters:{text:window.String,json:c.parseJSON,xml:c.parseXML}},id:null,readyState:0,send:function(a){this.readyState===0&&c.error("INVALID_STATE_ERR: Stream not open");arguments.length&&this.dataQueue.push(!a?"":(typeof a==="string"?a:c.param(a,c.ajaxSettings.traditional))+"&");if(this.sending!==!0)this.sending=!0,function f(){this.readyState===1&&this.dataQueue.length?c.ajax({url:this.url,context:this,type:"POST",data:this.dataQueue.shift()+this.paramMetadata("send"),complete:f}):this.sending= !1}.call(this)},close:function(){if(this.readyState<2)this.readyState=2,c.post(this.url,this.paramMetadata("close")),this.options.reconnect=!1,this.abort()},paramMetadata:function(a,b){var b=c.extend({},b,{id:this.id,type:a}),f={},d;for(d in b)f["metadata."+d]=b[d];return c.param(f)},handleResponse:function(a){if(this.readyState===0)this.id=a.substring(0,a.indexOf(";")),this.message={index:a.indexOf(";",this.id.length+1)+1,size:null,data:""},this.dataQueue=this.dataQueue||[],this.readyState=1,this.trigger("open"); for(;;){if(this.message.size==null){var b=a.indexOf(";",this.message.index);if(b<0)break;this.message.size=+a.substring(this.message.index,b);this.message.index=b+1}b=a.substr(this.message.index,this.message.size-this.message.data.length);this.message.data+=b;this.message.index+=b.length;if(this.message.size!==this.message.data.length)break;b=a.indexOf(";",this.message.index);if(b<0)break;this.message.index=b+1;this.message.data=this.options.converters[this.options.dataType](this.message.data);this.readyState< 3&&this.trigger("message",{data:this.message.data,origin:"",lastEventId:"",source:null,ports:null,openMessageEvent:c.noop});this.message.size=null;this.message.data=""}},handleClose:function(a){var b=this.readyState;this.readyState=3;if(a===!0)switch(this.options.reconnect=!1,b){case 0:this.trigger("close",{wasClean:!1,code:"",reason:"",initCloseEvent:c.noop});break;case 1:case 2:this.trigger("error")}else if(this.trigger("close",{wasClean:!0,code:"",reason:"",initCloseEvent:c.noop}),this.options.reconnect=== !0)this.readyState=0,this.open()},trigger:function(a,b){var f=[c.extend(c.Event(a),{eventPhase:2,currentTarget:this,srcElement:this,target:this,bubbles:!1,cancelable:!1},b)];if(this.options[a].length)for(var d,e=0;d=this.options[a][e];e++)d.apply(this.options.context,f);c.event.trigger("stream"+a.substring(0,1).toUpperCase()+a.substring(1),f)},openURL:function(){var a=/([?&]_=)[^&]*/;return(a.test(this.url)?this.url:this.url+(/\?/.test(this.url)?"&":"?")+"_=").replace(a,"$1"+(new Date).getTime())}}); c.extend(e,{instances:{},transports:{xhr:{open:function(){var a=this;this.xhr=new window.XMLHttpRequest;this.xhr.onreadystatechange=function(){switch(this.readyState){case 2:try{c.noop(this.status)}catch(b){this.opera=!0}break;case 3:if(this.status!==200)break;a.handleResponse(this.responseText);if(this.opera&&!this.polling)this.polling=!0,h(this,function(){if(this.readyState===4)return!1;this.responseText.length>a.message.index&&a.handleResponse(this.responseText)});break;case 4:a.handleClose(this.status!== 200)}};this.xhr.open("GET",this.openURL());this.xhr.send()},abort:function(){this.xhr.abort()}},xdr:{open:function(){var a=this;this.xdr=new window.XDomainRequest;this.xdr.onprogress=function(){a.handleResponse(this.responseText)};this.xdr.onerror=function(){a.handleClose(!0)};this.xdr.onload=function(){a.handleClose()};this.xdr.open("GET",this.openURL());this.xdr.send()},abort:function(){var a=this.xdr.onload;this.xdr.abort();a()}},iframe:{open:function(){this.doc=new window.ActiveXObject("htmlfile"); this.doc.open();this.doc.close();var a=this.doc.createElement("iframe");a.src=this.openURL();this.doc.body.appendChild(a);var b=a.contentDocument||a.contentWindow.document;h(this,function(){if(b.documentElement){if(b.readyState==="complete")try{c.noop(b.fileSize)}catch(a){return this.handleClose(!0),!1}var d=b.body.firstChild;this.handleResponse(d.innerText);h(this,function(){var a=d.innerText;if(a.length>this.message.index)this.handleResponse(a),d.innerText="",this.message.index=0;if(b.readyState=== "complete")return this.handleClose(),!1});return!1}})},abort:function(){this.doc.execCommand("Stop");this.doc=null}}}});var i=window.XDomainRequest?"xdr":window.ActiveXObject?"iframe":window.XMLHttpRequest?"xhr":null;i||c.error("Unsupported browser");c.extend(!0,e.prototype,e.transports[i]);c(document).bind("streamOpen",function(a,b){b.target.send()});c(window).unload(function(){c.each(e.instances,function(){this.close()})});c.stream=function(a,b){if(!arguments.length){for(var c in e.instances)return e.instances[c]; return null}return e.instances[a]||new e(a,b)};c.stream.version="1.0.0";c.each("streamOpen streamMessage streamError streamClose".split(" "),function(a,b){c.fn[b]=function(a){return this.bind(b,a)}})})(jQuery);